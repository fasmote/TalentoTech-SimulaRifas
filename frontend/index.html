<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Rifas - TalentoTech</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding-top: 80px;
        }

        /* Navegaci√≥n CORREGIDA - Fase 15c */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            position: relative;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
            flex-shrink: 0;
            min-width: 150px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 20px;
            margin: 0;
            padding: 0;
            flex: 1;
            justify-content: center;
            align-items: center;
            max-width: 600px;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 0.95rem;
        }

        .nav-links a:hover {
            background: #667eea;
            color: white;
        }

        .nav-links a.active {
            background: #667eea;
            color: white;
        }

        /* Nav user alineaci√≥n mejorada - FASE 15E */
        .nav-user {
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 200px;
            justify-content: flex-end;
        }

        .user-info {
            font-size: 0.85rem;
            color: #666;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .numbers-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4834d4, #686de0);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }

        .number-cell {
            position: relative;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            user-select: none;
        }

        .number-cell:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: scale(1.05);
        }

        .number-cell.selected {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
            border-color: #4caf50;
            transform: scale(1.1);
        }

        .number-cell.winner {
            background: linear-gradient(45deg, #ffd700, #ffb347);
            color: #333;
            border-color: #ffd700;
            animation: pulse 1s infinite;
        }

        .number-cell.sold {
            background: #ff6b6b !important;
            color: white !important;
            cursor: not-allowed !important;
            border-color: #ff6b6b !important;
        }

        /* NUEVO FASE 15C: Bot√≥n eliminar n√∫mero individual */
        .delete-number {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .number-cell.selected:hover .delete-number {
            opacity: 1;
        }

        .delete-number:hover {
            background: #d32f2f;
        }

        @keyframes pulse {
            0% { transform: scale(1.1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1.1); }
        }

        .cart-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: fit-content;
            max-height: 100%;
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .cart-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .cart-title {
            font-size: 1.3rem;
            color: #333;
        }

        .cart-count {
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            margin-left: auto;
        }

        .cart-items {
            overflow-y: auto;
            margin-bottom: 20px;
            flex-grow: 1;
            max-height: 400px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .cart-item-number {
            font-weight: bold;
            color: #4caf50;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .remove-btn:hover {
            background: #ff3742;
        }

        .empty-cart {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* Modales */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.5s ease;
        }

        .modal h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4caf50;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #4caf50;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.8); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .winner-display {
            font-size: 3rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 20px 0;
            text-align: center;
        }

        .winner-text {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            animation: slideInRight 0.3s ease;
        }

        .notification.error {
            background: #ff6b6b;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .rifas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .rifa-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .rifa-card:hover {
            transform: translateY(-5px);
        }

        .rifa-image {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .rifa-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .rifa-description {
            color: #666;
            margin-bottom: 15px;
        }

        .rifa-progress {
            margin-bottom: 15px;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Estilos espec√≠ficos Fase 15c */
        .access-code-display {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .access-code-input {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .code-share-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .legal-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        /* NUEVO: Bot√≥n de copiar c√≥digo */
        .copy-code-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .copy-code-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .copy-code-btn:active {
            transform: translateY(0);
        }
        
        /* NUEVO: Bot√≥n participar diferenciado */
        .btn-participate {
            background: linear-gradient(45deg, #ff9500, #ff6b00);
            color: white;
        }
        
        .btn-participate:hover {
            background: linear-gradient(45deg, #e68900, #e65f00);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 149, 0, 0.3);
        }
        
        /* NUEVO FASE 15C: Toggle de contrase√±a mejorado */
        .password-field {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
            padding: 0;
            display: flex;
            align-items: center;
            z-index: 1;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: #333;
        }

        /* NUEVO FASE 15C: Gesti√≥n de usuarios con n√∫meros */
        .user-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 5px 0;
            color: white;
        }

        .user-numbers {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            align-items: center;
        }

        .number-badge {
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .user-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            transform: translateY(-1px);
        }

        /* MEJORADO FASE 15E: Media queries responsive */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0 15px;
                height: 60px;
            }
            
            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                flex-direction: column;
                padding: 20px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                gap: 15px;
            }

            .nav-links.active {
                display: flex;
            }

            .mobile-menu-btn {
                display: block;
            }
            
            .nav-user {
                gap: 8px;
                min-width: 150px;
            }
            
            .user-info {
                font-size: 0.8rem;
                max-width: 80px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            /* Grid de detalles de rifa responsive */
            .rifa-details-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            h1 {
                font-size: 2rem;
            }

            .numbers-grid {
                grid-template-columns: repeat(10, 1fr);
            }

            .number-cell {
                font-size: 1rem;
            }

            .controls {
                justify-content: center;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .nav-container {
                padding: 0 10px;
                height: 60px;
            }
            
            .logo {
                font-size: 1.3rem;
                min-width: 120px;
            }
            
            .nav-user {
                min-width: 120px;
                gap: 6px;
            }
            
            .user-info {
                display: none; /* Ocultar en pantallas muy peque√±as */
            }

            .numbers-grid {
                grid-template-columns: repeat(8, 1fr);
                gap: 4px;
            }

            .number-cell {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navegaci√≥n -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="logo" onclick="navigateTo('demo')">üé≤ SimulaRifa TT</a>
            <ul class="nav-links" id="navLinks">
                <li><a href="#" class="active" onclick="navigateTo('demo')">Inicio</a></li>
                <li><a href="#" onclick="navigateTo('rifas')">Simulaciones P√∫blicas</a></li>
                <li><a href="#" onclick="navigateTo('codigo')">Acceder por C√≥digo</a></li>
                <li><a href="#" onclick="navigateTo('perfil')" id="perfilLink" style="display: none;">Mis Simulaciones</a></li>
            </ul>
            <div class="nav-user" id="navUser">
                <span class="user-info" id="userInfo" style="display: none;"></span>
                <button class="btn btn-secondary" id="authBtn" onclick="showAuthModal()">Iniciar Sesi√≥n</button>
            </div>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
        </div>
    </nav>

    <div class="container" id="mainContainer">
        <!-- El contenido se carga din√°micamente aqu√≠ -->
    </div>

    <!-- Modal de Autenticaci√≥n -->
    <div class="modal" id="authModal" style="display: none;">
        <div class="modal-content">
            <h2 id="authTitle">Iniciar Sesi√≥n</h2>
            <form id="authForm">
                <input type="text" id="authUsername" placeholder="Usuario o Email" class="form-input" required>
                <input type="email" id="authEmail" placeholder="Email" class="form-input" style="display: none;">
                <div class="password-field">
                    <input type="password" id="authPassword" placeholder="Contrase√±a" class="form-input" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('authPassword', this)">
                        üëÅÔ∏è
                    </button>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeAuthModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="authSubmit">Ingresar</button>
                </div>
            </form>
            <p style="text-align: center; margin-top: 15px;">
                <a href="#" id="authSwitch" onclick="switchAuthMode()">¬øNo tienes cuenta? Reg√≠strate</a>
            </p>
        </div>
    </div>

    <!-- Modal de Ganador -->
    <div class="modal" id="winnerModal" style="display: none;">
        <div class="modal-content">
            <h2>üéâ ¬°Tenemos un Ganador! üéâ</h2>
            <div class="winner-display" id="winnerNumber">--</div>
            <p class="winner-text">¬°Felicidades al ganador del n√∫mero <span id="winnerText">--</span>!</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeWinnerModal()">‚úì Cerrar</button>
                <button class="btn btn-primary" onclick="resetGame()">üîÑ Nueva Simulaci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal de Crear Simulaci√≥n -->
    <div class="modal" id="createRifaModal" style="display: none;">
        <div class="modal-content">
            <h2>Crear Nueva Simulaci√≥n</h2>
            <div class="legal-notice">
                <strong>Aviso:</strong> Esta es una simulaci√≥n educativa sin valor monetario. No implica transacciones de dinero ni juegos de apuestas.
            </div>
            <form id="createRifaForm">
                <input type="text" id="rifaTitle" placeholder="T√≠tulo de la simulaci√≥n" class="form-input" required>
                <textarea id="rifaDescription" placeholder="Descripci√≥n del premio o evento" class="form-textarea" required></textarea>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateRifaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Crear Simulaci√≥n</button>
                </div>
            </form>
        </div>
    </div>



    <!-- NUEVO FASE 15C: Modal de Editar Simulaci√≥n -->
    <div class="modal" id="editRifaModal" style="display: none;">
        <div class="modal-content">
            <h2>‚úèÔ∏è Editar Simulaci√≥n</h2>
            <form id="editRifaForm">
                <input type="text" id="editRifaTitle" placeholder="T√≠tulo de la simulaci√≥n" class="form-input" required>
                <textarea id="editRifaDescription" placeholder="Descripci√≥n del premio o evento" class="form-textarea" required></textarea>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeEditRifaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Actualizar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let selectedNumbers = [];
        let winnerNumber = null;
        let currentRifa = null;
        let isAuthMode = 'login';
        let accessedByCode = false;

        // API Base URL
        const API_BASE = '/api';

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            navigateTo('demo');
        });

        // ========== FUNCIONES NUEVAS FASE 15C ==========

        // NUEVO: Toggle de contrase√±a mejorado
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = 'üôà';
            } else {
                input.type = 'password';
                button.innerHTML = 'üëÅÔ∏è';
            }
        }

        // NUEVO: Eliminar n√∫mero espec√≠fico 
        function removeUserNumber(number, userName, rifaId) {
            if (confirm(`¬øEliminar el n√∫mero ${number} de ${userName}?`)) {
                // Implementar la llamada a la API
                removeNumberFromRifa(rifaId, number, userName);
            }
        }

        // NUEVO: Eliminar todos los n√∫meros de un usuario
        function removeAllUserNumbers(userName, rifaId) {
            if (confirm(`¬øEliminar TODOS los n√∫meros de ${userName}? Esta acci√≥n no se puede deshacer.`)) {
                // Implementar la llamada a la API
                removeAllNumbersFromUser(rifaId, userName);
            }
        }

        // NUEVO: Funci√≥n API para eliminar n√∫mero espec√≠fico
        async function removeNumberFromRifa(rifaId, number, userName) {
            try {
                const response = await fetch(`${API_BASE}/rifas/${rifaId}/numbers/${number}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ participant_name: userName })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`N√∫mero ${number} eliminado de ${userName}`);
                    // Recargar vista de detalles
                    viewRifa(rifaId);
                } else {
                    showNotification(data.error || 'Error eliminando n√∫mero', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        }

        // NUEVO: Funci√≥n API para eliminar todos los n√∫meros de un usuario
        async function removeAllNumbersFromUser(rifaId, userName) {
            try {
                const response = await fetch(`${API_BASE}/rifas/${rifaId}/users/${encodeURIComponent(userName)}/numbers`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Todos los n√∫meros de ${userName} han sido eliminados`);
                    // Recargar vista de detalles
                    viewRifa(rifaId);
                } else {
                    showNotification(data.error || 'Error eliminando n√∫meros', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        }

        // ========== FUNCIONES SISTEMA DE NOTIFICACI√ìN ==========

        function showNotification(message, type = 'success') {
            // Remover notificaci√≥n existente si la hay
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Crear nueva notificaci√≥n
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Auto-remover despu√©s de 4 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        // ========== AUTENTICACI√ìN ==========

        async function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        currentUser = data.user;
                        updateNavForLoggedUser();
                    } else {
                        localStorage.removeItem('authToken');
                    }
                } catch (error) {
                    console.error('Error verificando autenticaci√≥n:', error);
                    localStorage.removeItem('authToken');
                }
            }
        }

        function updateNavForLoggedUser() {
            const userInfo = document.getElementById('userInfo');
            const authBtn = document.getElementById('authBtn');
            const perfilLink = document.getElementById('perfilLink');
            
            if (currentUser) {
                userInfo.textContent = `Hola, ${currentUser.username}`;
                userInfo.style.display = 'block';
                authBtn.textContent = 'Cerrar Sesi√≥n';
                authBtn.onclick = logout;
                
                // Mostrar opci√≥n "Mis Simulaciones" cuando est√° logueado
                if (perfilLink) {
                    perfilLink.style.display = 'block';
                }
            } else {
                userInfo.style.display = 'none';
                authBtn.textContent = 'Iniciar Sesi√≥n';
                authBtn.onclick = showAuthModal;
                
                // Ocultar opci√≥n "Mis Simulaciones" cuando NO est√° logueado
                if (perfilLink) {
                    perfilLink.style.display = 'none';
                }
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            switchAuthMode('login');
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authForm').reset();
        }

        function switchAuthMode(mode = null) {
            const title = document.getElementById('authTitle');
            const emailField = document.getElementById('authEmail');
            const submitBtn = document.getElementById('authSubmit');
            const switchLink = document.getElementById('authSwitch');
            
            if (mode) {
                isAuthMode = mode;
            } else {
                isAuthMode = isAuthMode === 'login' ? 'register' : 'login';
            }
            
            if (isAuthMode === 'register') {
                title.textContent = 'Registrarse';
                emailField.style.display = 'block';
                emailField.required = true;
                submitBtn.textContent = 'Registrarse';
                switchLink.textContent = '¬øYa tienes cuenta? Inicia sesi√≥n';
            } else {
                title.textContent = 'Iniciar Sesi√≥n';
                emailField.style.display = 'none';
                emailField.required = false;
                submitBtn.textContent = 'Ingresar';
                switchLink.textContent = '¬øNo tienes cuenta? Reg√≠strate';
            }
        }

        document.getElementById('authForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('authUsername').value;
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            try {
                const endpoint = isAuthMode === 'register' ? 'register' : 'login';
                const body = isAuthMode === 'register' 
                    ? { username, email, password }
                    : { username, password };
                
                const response = await fetch(`${API_BASE}/auth/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('authToken', data.token);
                    currentUser = data.user;
                    updateNavForLoggedUser();
                    closeAuthModal();
                    showNotification(data.message);
                    
                    // NUEVO: Ir directo a "Mis Simulaciones" despu√©s del login
                    navigateTo('perfil');
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Error en autenticaci√≥n:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        });

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
            } catch (error) {
                console.error('Error en logout:', error);
            }
            
            localStorage.removeItem('authToken');
            currentUser = null;
            updateNavForLoggedUser();
            showNotification('Sesi√≥n cerrada');
            
            // NUEVO: Ir al inicio al cerrar sesi√≥n
            navigateTo('demo');
        }

        // ========== NAVEGACI√ìN ==========

        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('active');
        }

        function navigateTo(page) {
            switch(page) {
                case 'rifas':
                    showRifasPage();
                    updateActiveNav('rifas');
                    break;
                case 'codigo':
                    showCodigoPage();
                    updateActiveNav('codigo');
                    break;
                case 'perfil':
                    if (!currentUser) {
                        showAuthModal();
                        return;
                    }
                    showPerfilPage();
                    updateActiveNav('perfil');
                    break;
                case 'demo':
                    showDemoPage();
                    updateActiveNav('demo');
                    break;
            }
            
            // Cerrar men√∫ m√≥vil
            document.getElementById('navLinks').classList.remove('active');
        }

        function updateActiveNav(activePage) {
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });
            
            const pageIndex = activePage === 'demo' ? 0 : 
                             activePage === 'rifas' ? 1 : 
                             activePage === 'codigo' ? 2 : 3;
            const links = document.querySelectorAll('.nav-links a');
            if (links[pageIndex]) {
                links[pageIndex].classList.add('active');
            }
        }

        // ========== P√ÅGINAS ==========

        function showDemoPage() {
            document.getElementById('mainContainer').innerHTML = `
                <header>
                    <h1>üé≤ Simulador de Rifas</h1>
                    <p class="subtitle">Simula sorteos para eventos, fiestas y actividades grupales</p>
                </header>

                <div class="legal-notice">
                    <strong>Aviso Legal:</strong> Esta es una aplicaci√≥n de simulaci√≥n educativa. No involucra dinero real ni constituye un juego de apuestas. Cumple con la normativa argentina sobre juegos.
                </div>

                <div class="main-content">
                    <div class="numbers-section">
                        <div class="controls">
                            <button class="btn btn-secondary" onclick="selectRandomNumber()">
                                üéØ Elegir al Azar
                            </button>
                            <button class="btn btn-primary" onclick="clearSelection()">
                                üóëÔ∏è Limpiar Todo
                            </button>
                            <button class="btn btn-success" onclick="drawWinner()">
                                üèÜ Simular Sorteo
                            </button>
                        </div>
                        
                        <div class="numbers-grid" id="numbersGrid">
                            <!-- Los n√∫meros se generan con JavaScript -->
                        </div>
                    </div>

                    <div class="cart-section">
                        <div class="cart-header">
                            <span class="cart-icon">üéØ</span>
                            <h3 class="cart-title">N√∫meros Seleccionados</h3>
                            <div class="cart-count" id="cartCount">0</div>
                        </div>
                        
                        <div class="cart-items" id="cartItems">
                            <div class="empty-cart">
                                No has seleccionado n√∫meros a√∫n
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="drawWinner()">
                            üéä ¬°Simular Sorteo!
                        </button>
                        
                        <div style="margin-bottom: 15px;">
                            <p style="font-size: 0.9rem; color: #666; text-align: center;">
                                üí° ¬øQuieres crear tus propias simulaciones privadas?
                            </p>
                            <button class="btn btn-secondary" style="width: 100%;" onclick="showAuthModal()">
                                üë§ Iniciar Sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            selectedNumbers = [];
            winnerNumber = null;
            currentRifa = null;
            accessedByCode = false;
            generateNumbersGrid();
            updateCart();
        }

        // ========== SIMULADOR (MODO DEMO) ==========

        function generateNumbersGrid() {
            const grid = document.getElementById('numbersGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            for (let i = 0; i <= 99; i++) {
                const cell = document.createElement('div');
                cell.className = 'number-cell';
                cell.textContent = i.toString().padStart(2, '0');
                cell.onclick = () => toggleNumber(i);
                cell.id = `number-${i}`;
                
                grid.appendChild(cell);
            }
        }

        function toggleNumber(number) {
            const cell = document.getElementById(`number-${number}`);
            if (!cell || cell.classList.contains('sold')) return;
            
            const index = selectedNumbers.indexOf(number);
            
            if (index > -1) {
                selectedNumbers.splice(index, 1);
                cell.classList.remove('selected');
                // Remover bot√≥n de eliminaci√≥n
                const deleteBtn = cell.querySelector('.delete-number');
                if (deleteBtn) {
                    deleteBtn.remove();
                }
            } else {
                selectedNumbers.push(number);
                cell.classList.add('selected');
                // Agregar bot√≥n de eliminaci√≥n en modo demo
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-number';
                deleteBtn.innerHTML = '‚úï';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    toggleNumber(number);
                };
                cell.appendChild(deleteBtn);
            }
            
            updateCart();
        }

        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            
            if (!cartItems || !cartCount) return;
            
            cartCount.textContent = selectedNumbers.length;
            
            if (selectedNumbers.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart">No has seleccionado n√∫meros a√∫n</div>';
                return;
            }
            
            const sortedNumbers = [...selectedNumbers].sort((a, b) => a - b);
            cartItems.innerHTML = sortedNumbers.map(number => `
                <div class="cart-item">
                    <span class="cart-item-number">${number.toString().padStart(2, '0')}</span>
                    <button class="remove-btn" onclick="toggleNumber(${number})">‚úï</button>
                </div>
            `).join('');
        }

        function selectRandomNumber() {
            const available = [];
            for (let i = 0; i <= 99; i++) {
                if (!selectedNumbers.includes(i)) {
                    const cell = document.getElementById(`number-${i}`);
                    if (cell && !cell.classList.contains('sold')) {
                        available.push(i);
                    }
                }
            }
            
            if (available.length > 0) {
                const randomIndex = Math.floor(Math.random() * available.length);
                const randomNumber = available[randomIndex];
                toggleNumber(randomNumber);
            }
        }

        function clearSelection() {
            selectedNumbers.forEach(number => {
                const cell = document.getElementById(`number-${number}`);
                if (cell) {
                    cell.classList.remove('selected', 'winner');
                    // Remover bot√≥n de eliminaci√≥n
                    const deleteBtn = cell.querySelector('.delete-number');
                    if (deleteBtn) {
                        deleteBtn.remove();
                    }
                }
            });
            selectedNumbers = [];
            winnerNumber = null;
            updateCart();
            closeWinnerModal();
        }

        function drawWinner() {
            if (selectedNumbers.length === 0) {
                showNotification('¬°Primero debes seleccionar al menos un n√∫mero!', 'error');
                return;
            }

            // Limpiar ganador anterior
            if (winnerNumber !== null) {
                const oldWinnerCell = document.getElementById(`number-${winnerNumber}`);
                if (oldWinnerCell) {
                    oldWinnerCell.classList.remove('winner');
                }
            }

            // Seleccionar ganador al azar
            const randomIndex = Math.floor(Math.random() * selectedNumbers.length);
            winnerNumber = selectedNumbers[randomIndex];
            
            // Mostrar animaci√≥n
            const winnerCell = document.getElementById(`number-${winnerNumber}`);
            if (winnerCell) {
                winnerCell.classList.add('winner');
            }
            
            // Mostrar modal de resultado
            showWinnerModal();
        }

        function showWinnerModal() {
            if (winnerNumber === null) return;
            
            document.getElementById('winnerNumber').textContent = winnerNumber.toString().padStart(2, '0');
            document.getElementById('winnerText').textContent = winnerNumber.toString().padStart(2, '0');
            document.getElementById('winnerModal').style.display = 'flex';
        }

        function closeWinnerModal() {
            document.getElementById('winnerModal').style.display = 'none';
        }

        function resetGame() {
            clearSelection();
            closeWinnerModal();
        }

        // ========== FUNCIONES PLACEHOLDER (SIMULAR API) ==========
        // Estas funciones se implementar√°n cuando el backend est√© completo

        async function showRifasPage() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="page-header">
                    <h1>üéä Simulaciones P√∫blicas</h1>
                    <p class="subtitle">Explora simulaciones de ejemplo y practica</p>
                </div>
                
                <div class="legal-notice">
                    <strong>Simulaciones de Demostraci√≥n:</strong> Estas son simulaciones p√∫blicas creadas para fines educativos y de demostraci√≥n. No involucran dinero real.
                </div>
                
                <div class="loading">
                    <p>üîÑ Cargando simulaciones p√∫blicas...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/rifas`);
                const data = await response.json();
                
                if (response.ok && data.rifas && data.rifas.length > 0) {
                    // Mostrar rifas p√∫blicas
                    const rifasHtml = data.rifas.map(rifa => {
                        const emoji = rifa.title.includes('iPhone') ? 'üì±' : 
                                     rifa.title.includes('Cartera') ? 'üëú' : '‚úàÔ∏è';
                        const progressPercent = rifa.max_numbers ? Math.round((rifa.numbers_sold / rifa.max_numbers) * 100) : 0;
                        
                        return `
                            <div class="rifa-card">
                                <div class="rifa-image">${emoji}</div>
                                <h3>${rifa.title}</h3>
                                <p class="rifa-description">${rifa.description}</p>
                                <div class="rifa-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <p class="progress-text">${rifa.numbers_sold}/100 n√∫meros seleccionados</p>
                                </div>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-primary" onclick="viewPublicRifa(${rifa.id})" style="width: 100%;">
                                        üëÄ Ver Detalles
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('mainContainer').innerHTML = `
                        <div class="page-header">
                            <h1>üéä Simulaciones P√∫blicas</h1>
                            <p class="subtitle">Explora simulaciones de ejemplo y practica</p>
                        </div>
                        
                        <div class="legal-notice">
                            <strong>Simulaciones de Demostraci√≥n:</strong> Estas son simulaciones p√∫blicas creadas para fines educativos y de demostraci√≥n. No involucran dinero real.
                        </div>
                        
                        <div class="rifas-grid">
                            ${rifasHtml}
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">
                                üí° ¬øQuieres crear tus propias simulaciones privadas?
                            </p>
                            <button class="btn btn-success" onclick="showAuthModal()">
                                üë§ Iniciar Sesi√≥n para Crear
                            </button>
                        </div>
                    `;
                } else {
                    // No hay rifas p√∫blicas disponibles
                    document.getElementById('mainContainer').innerHTML = `
                        <div class="page-header">
                            <h1>üéä Simulaciones P√∫blicas</h1>
                            <p class="subtitle">Explora simulaciones de ejemplo y practica</p>
                        </div>
                        
                        <div class="legal-notice">
                            <strong>Simulaciones de Demostraci√≥n:</strong> Estas son simulaciones p√∫blicas creadas para fines educativos y de demostraci√≥n. No involucran dinero real.
                        </div>
                        
                        <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px; margin: 20px 0;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üéÅ</div>
                            <h3 style="color: #333; margin-bottom: 15px;">No hay simulaciones p√∫blicas disponibles</h3>
                            <p style="color: #666; margin-bottom: 30px;">Parece que a√∫n no se han creado las simulaciones de demostraci√≥n.</p>
                            
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
                                <h4 style="color: #856404; margin: 0 0 10px 0;">üîß Para activar el contenido demo:</h4>
                                <p style="color: #856404; font-size: 0.9rem; margin: 0;">
                                    Ejecuta: <code>npm run demo-content</code> en la carpeta backend
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="navigateTo('demo')">
                                    üéÆ Probar Simulador
                                </button>
                                <button class="btn btn-success" onclick="showAuthModal()">
                                    ‚ûï Crear Cuenta
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando rifas p√∫blicas:', error);
                document.getElementById('mainContainer').innerHTML = `
                    <div class="page-header">
                        <h1>üéä Simulaciones P√∫blicas</h1>
                        <p class="subtitle">Explora simulaciones de ejemplo y practica</p>
                    </div>
                    
                    <div class="legal-notice">
                        <strong>Error de Conexi√≥n:</strong> No se pudo conectar con el servidor. Aseg√∫rate de que el backend est√© ejecut√°ndose.
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px; margin: 20px 0;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3 style="color: #333; margin-bottom: 15px;">Error de Conexi√≥n</h3>
                        <p style="color: #666; margin-bottom: 30px;">No se pudo conectar con el servidor backend.</p>
                        
                        <div style="background: #ffebee; border: 1px solid #ffcdd2; border-radius: 8px; padding: 20px; margin: 20px 0;">
                            <h4 style="color: #c62828; margin: 0 0 10px 0;">üîß Soluciones:</h4>
                            <p style="color: #c62828; font-size: 0.9rem; margin: 0; text-align: left;">
                                1. Aseg√∫rate de que el backend est√© corriendo: <code>npm run dev</code><br>
                                2. Verifica que est√© en: <code>http://localhost:3000</code><br>
                                3. Ejecuta contenido demo: <code>npm run demo-content</code>
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="navigateTo('demo')">
                                üéÆ Probar Simulador
                            </button>
                            <button class="btn btn-primary" onclick="location.reload()">
                                üîÑ Reintentar
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function showCodigoPage() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="page-header">
                    <h1>üîë Acceder por C√≥digo</h1>
                    <p class="subtitle">Ingresa el c√≥digo de una simulaci√≥n privada</p>
                </div>
                
                <div style="max-width: 500px; margin: 0 auto;">
                    <div style="background: white; border-radius: 15px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üîë</div>
                        <h3 style="margin-bottom: 20px; color: #333;">C√≥digo de Acceso</h3>
                        <p style="color: #666; margin-bottom: 30px;">
                            Ingresa el c√≥digo de 6 caracteres para acceder a la simulaci√≥n
                        </p>
                        
                        <form id="accessCodePageForm">
                            <input type="text" id="accessCodePageInput" placeholder="XXXXXX" class="form-input access-code-input" 
                                   maxlength="6" pattern="[A-Za-z0-9]{6}" required style="margin-bottom: 20px;">
                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                                üîç Acceder a Simulaci√≥n
                            </button>
                        </form>
                        
                        <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
                            <h4 style="color: #1565c0; margin: 0 0 10px 0;">‚ú® ¬øC√≥mo funciona?</h4>
                            <p style="color: #1565c0; font-size: 0.9rem;">
                                ‚Ä¢ Obt√©n el c√≥digo del creador de la simulaci√≥n<br>
                                ‚Ä¢ Ingr√©salo aqu√≠ para participar<br>
                                ‚Ä¢ No necesitas registrarte
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="navigateTo('demo')">
                                üéÆ Probar Simulador
                            </button>
                            <button class="btn btn-success" onclick="showAuthModal()">
                                ‚ûï Crear Cuenta
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // CORREGIDO: Agregar event listener despu√©s de crear el HTML
            setTimeout(() => {
                const form = document.getElementById('accessCodePageForm');
                if (form) {
                    form.addEventListener('submit', handleAccessCodeSubmit);
                }
            }, 100);
        }

        async function showPerfilPage() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            document.getElementById('mainContainer').innerHTML = `
                <div class="page-header">
                    <h1>üë• Mis Simulaciones</h1>
                    <p class="subtitle">Gestiona tu cuenta y tus simulaciones privadas</p>
                </div>
                
                <div class="loading">
                    <p>üîÑ Cargando tus simulaciones...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/rifas/my`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const userRifas = data.rifas || [];
                    
                    let rifasHtml = '';
                    if (userRifas.length > 0) {
                        rifasHtml = userRifas.map(rifa => {
                            const progressPercent = Math.round((rifa.numbers_sold / 100) * 100);
                            return `
                                <div class="rifa-card">
                                    <div class="rifa-image">üéØ</div>
                                    <h3>${rifa.title}</h3>
                                    <p class="rifa-description">${rifa.description}</p>
                                    
                                    <div class="rifa-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                        </div>
                                        <p class="progress-text">${rifa.numbers_sold}/100 n√∫meros</p>
                                    </div>
                                    
                                    <div style="margin-top: 15px;">
                                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                                            üîë C√≥digo: <strong>${rifa.access_code || 'Generando...'}</strong>
                                            <button class="copy-code-btn" onclick="copyCode('${rifa.access_code}')" title="Copiar c√≥digo" style="margin-left: 5px; padding: 3px 6px; font-size: 0.7rem;">
                                                üìã
                                            </button>
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                                        <button class="btn btn-primary" onclick="viewRifa(${rifa.id})" style="flex: 1; font-size: 0.9rem;">
                                            üëÅÔ∏è Ver
                                        </button>
                                        <button class="btn btn-secondary" onclick="editRifa(${rifa.id})" style="flex: 1; font-size: 0.9rem;">
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button class="btn" onclick="deleteRifa(${rifa.id})" style="background: #ff6b6b; color: white; flex: 0.5; font-size: 0.9rem;">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        rifasHtml = `
                            <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px; grid-column: 1 / -1;">
                                <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                                <h3 style="color: #333; margin-bottom: 15px;">A√∫n no tienes simulaciones</h3>
                                <p style="color: #666; margin-bottom: 30px;">Crea tu primera simulaci√≥n para empezar a gestionar sorteos.</p>
                                
                                <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 20px; margin: 20px 0;">
                                    <h4 style="color: #1565c0; margin: 0 0 10px 0;">üéØ ¬°Empieza ahora!</h4>
                                    <p style="color: #1565c0; font-size: 0.9rem; margin: 0;">
                                        Haz click en "Crear Nueva Simulaci√≥n" para empezar
                                    </p>
                                </div>
                                
                                <button class="btn btn-primary" onclick="navigateTo('demo')">
                                    üé≤ Probar Simulador Demo
                                </button>
                            </div>
                        `;
                    }
                    
                    document.getElementById('mainContainer').innerHTML = `
                        <div class="page-header">
                            <h1>üë• Mis Simulaciones</h1>
                            <p class="subtitle">Gestiona tu cuenta y tus simulaciones privadas</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-success" onclick="showCreateRifaModal()">
                                ‚ûï Crear Nueva Simulaci√≥n
                            </button>
                        </div>
                        
                        <div class="rifas-grid">
                            ${rifasHtml}
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-secondary" onclick="logout()">
                                üö™ Cerrar Sesi√≥n
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error('Error cargando simulaciones');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mainContainer').innerHTML = `
                    <div class="page-header">
                        <h1>üë• Mis Simulaciones</h1>
                        <p class="subtitle">Gestiona tu cuenta y tus simulaciones privadas</p>
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3 style="color: #333; margin-bottom: 15px;">Error de Conexi√≥n</h3>
                        <p style="color: #666; margin-bottom: 30px;">No se pudieron cargar tus simulaciones. Verifica que el backend est√© ejecut√°ndose.</p>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="showPerfilPage()">
                                üîÑ Reintentar
                            </button>
                            <button class="btn btn-secondary" onclick="navigateTo('demo')">
                                üé≤ Probar Demo
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // ========== FUNCIONES RIFAS P√öBLICAS - FASE 15C ==========
        
        async function viewPublicRifa(rifaId) {
            document.getElementById('mainContainer').innerHTML = `
                <div class="loading">
                    <p>üîÑ Cargando detalles de la simulaci√≥n...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/rifas/${rifaId}`);
                const data = await response.json();
                
                if (response.ok && data.rifa) {
                    const rifa = data.rifa;
                    const isCompleted = rifa.status === 'completed';
                    const winnerNumber = rifa.winner ? rifa.winner.number : null;
                    const emoji = rifa.title.includes('iPhone') ? 'üì±' : 
                                 rifa.title.includes('Cartera') ? 'üëú' : '‚úàÔ∏è';
                    const progressPercent = rifa.max_numbers ? Math.round((rifa.numbers_sold / rifa.max_numbers) * 100) : 0;
                    
                    // Generar grid de n√∫meros
                    let numbersGridHtml = '';
                    for (let i = 0; i <= 99; i++) {
                        const isSelected = rifa.sold_numbers && rifa.sold_numbers.includes(i);
                        const isWinner = winnerNumber === i;
                        let cellClass = 'number-cell';
                        
                        if (isWinner) {
                            cellClass = 'number-cell winner';
                        } else if (isSelected) {
                            cellClass = 'number-cell sold';
                        }
                        
                        numbersGridHtml += `<div class="${cellClass}">${i.toString().padStart(2, '0')}</div>`;
                    }
                    
                    document.getElementById('mainContainer').innerHTML = `
                        <div class="page-header">
                            <h1>${emoji} ${rifa.title}</h1>
                            <p class="subtitle">Simulaci√≥n p√∫blica de demostraci√≥n</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-secondary" onclick="navigateTo('rifas')">
                                ‚Üê Volver a Simulaciones P√∫blicas
                            </button>
                        </div>
                        
                        <div class="legal-notice">
                            <strong>Vista de Solo Lectura:</strong> Esta es una simulaci√≥n p√∫blica de demostraci√≥n. Los n√∫meros mostrados en rojo ya est√°n ocupados por otros participantes.
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px; margin-bottom: 30px;" class="rifa-details-grid">
                            <div class="numbers-section">
                                <h3 style="margin-bottom: 15px; color: #333;">üéØ N√∫meros de la Simulaci√≥n</h3>
                                <p style="color: #666; margin-bottom: 20px;">Los n√∫meros en rojo ya est√°n seleccionados</p>
                                
                                <div class="numbers-grid">
                                    ${numbersGridHtml}
                                </div>
                                
                                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">üìä Estad√≠sticas</h4>
                                    <p style="margin: 5px 0; color: #666;">‚Ä¢ N√∫meros ocupados: ${rifa.numbers_sold}/100</p>
                                    <p style="margin: 5px 0; color: #666;">‚Ä¢ Progreso: ${progressPercent}%</p>
                                    <p style="margin: 5px 0; color: #666;">‚Ä¢ Estado: ${rifa.status === 'active' ? 'Activa' : 'Finalizada'}</p>
                                </div>
                            </div>
                            
                            <div class="cart-section">
                                <div class="cart-header">
                                    <span class="cart-icon">${emoji}</span>
                                    <h3 class="cart-title">Informaci√≥n</h3>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">üìù Descripci√≥n</h4>
                                    <p style="color: #666; line-height: 1.5; font-size: 0.9rem;">${rifa.description}</p>
                                </div>
                                
                                <div class="rifa-progress" style="margin-bottom: 20px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">üìà Progreso</h4>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <p class="progress-text">${rifa.numbers_sold}/100 n√∫meros seleccionados</p>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">‚ÑπÔ∏è Detalles</h4>
                                    <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">‚Ä¢ Creador: ${rifa.creator_username || 'Sistema'}</p>
                                    <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">‚Ä¢ Tipo: Simulaci√≥n p√∫blica</p>
                                    <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">‚Ä¢ Fines: Educativos/Demo</p>
                                </div>
                                
                                <div style="text-align: center; margin-top: 20px;">
                                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                                        üí° ¬øTe gusta esta simulaci√≥n?
                                    </p>
                                    <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="showAuthModal()">
                                        üöÄ Crear Mi Propia Simulaci√≥n
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%;" onclick="navigateTo('demo')">
                                        üéÆ Probar Simulador
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 20px; text-align: center;">
                            <h4 style="color: #1565c0; margin: 0 0 10px 0;">üéì Simulaci√≥n Educativa</h4>
                            <p style="color: #1565c0; font-size: 0.9rem; margin: 0;">
                                Esta es una simulaci√≥n de demostraci√≥n sin valor monetario. Los participantes y n√∫meros son ficticios con fines educativos.
                            </p>
                        </div>
                    `;
                } else {
                    document.getElementById('mainContainer').innerHTML = `
                        <div class="page-header">
                            <h1>‚ùå Simulaci√≥n No Encontrada</h1>
                            <p class="subtitle">La simulaci√≥n solicitada no existe o no est√° disponible</p>
                        </div>
                        
                        <div style="text-align: center; padding: 40px; background: white; border-radius: 15px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                            <h3 style="color: #333; margin-bottom: 15px;">Simulaci√≥n no encontrada</h3>
                            <p style="color: #666; margin-bottom: 25px;">La simulaci√≥n que buscas no existe o no est√° disponible p√∫blicamente.</p>
                            
                            <button class="btn btn-primary" onclick="navigateTo('rifas')">
                                ‚Üê Volver a Simulaciones P√∫blicas
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando detalles de rifa:', error);
                document.getElementById('mainContainer').innerHTML = `
                    <div class="page-header">
                        <h1>‚ö†Ô∏è Error de Conexi√≥n</h1>
                        <p class="subtitle">No se pudo cargar la simulaci√≥n</p>
                    </div>
                    
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 15px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üåê</div>
                        <h3 style="color: #333; margin-bottom: 15px;">Error de conexi√≥n</h3>
                        <p style="color: #666; margin-bottom: 25px;">No se pudo conectar con el servidor. Verifica que el backend est√© ejecut√°ndose.</p>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="navigateTo('rifas')">
                                ‚Üê Volver
                            </button>
                            <button class="btn btn-primary" onclick="location.reload()">
                                üîÑ Reintentar
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // ======== FUNCIONES RIFAS - FASE 15E CORREGIDA ========
        
        // ========== FUNCI√ìN VIEWRIFA CORREGIDA - FASE 14 ==========
        
        async function viewRifa(rifaId) {
            console.log(`üîç [DEBUG] Iniciando viewRifa con ID: ${rifaId}`);
            
            // Validar ID
            if (!rifaId || rifaId === 'undefined' || rifaId === 'null') {
                console.error('‚ùå [ERROR] ID de rifa inv√°lido:', rifaId);
                showNotification('Error: ID de simulaci√≥n inv√°lido', 'error');
                return;
            }
            
            // Validar autenticaci√≥n
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.error('‚ùå [ERROR] No hay token de autenticaci√≥n');
                showNotification('Debes iniciar sesi√≥n para ver esta simulaci√≥n', 'error');
                showAuthModal();
                return;
            }
            
            console.log(`‚úÖ [DEBUG] Token encontrado: ${token.substring(0, 20)}...`);
            
            // Mostrar loading
            document.getElementById('mainContainer').innerHTML = `
                <div class="loading">
                    <p>üîÑ Cargando detalles de la simulaci√≥n...</p>
                </div>
            `;
            
            try {
                console.log(`üì° [DEBUG] Haciendo petici√≥n a: /api/rifas/my/${rifaId}`);
                
                const response = await fetch(`${API_BASE}/rifas/my/${rifaId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log(`üì° [DEBUG] Respuesta recibida. Status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå [ERROR] Respuesta no OK: ${response.status} - ${errorText}`);
                    
                    let errorMessage = 'Error cargando simulaci√≥n';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = `Error ${response.status}: ${errorText}`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('‚úÖ [DEBUG] Datos recibidos:', data);
                
                if (!data.rifa) {
                    throw new Error('Datos de simulaci√≥n no encontrados en respuesta');
                }
                
                const rifa = data.rifa;
                const isCompleted = rifa.status === 'completed';
                const winnerNumber = rifa.winner ? rifa.winner.number : null;
                
                console.log(`‚úÖ [DEBUG] Procesando rifa: "${rifa.title}" (Status: ${rifa.status})`);
                
                // Generar grid de n√∫meros
                let numbersGridHtml = '';
                for (let i = 0; i <= 99; i++) {
                    const isSelected = rifa.sold_numbers && rifa.sold_numbers.includes(i);
                    const isWinner = winnerNumber === i;
                    let cellClass = 'number-cell';
                    
                    if (isWinner) {
                        cellClass = 'number-cell winner';
                    } else if (isSelected) {
                        cellClass = 'number-cell sold';
                    }
                    
                    numbersGridHtml += `<div class="${cellClass}">${i.toString().padStart(2, '0')}</div>`;
                }
                
                const progressPercent = Math.round((rifa.numbers_sold / 100) * 100);
                
                console.log(`‚úÖ [DEBUG] Generando HTML para la vista...`);
                
                document.getElementById('mainContainer').innerHTML = `
                    <div class="page-header">
                        <h1>üéØ ${rifa.title}</h1>
                        <p class="subtitle">${rifa.description}</p>
                        ${isCompleted ? `<p style="background: #4caf50; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px;">
                            üèÜ ¬°SIMULACI√ìN COMPLETADA! Ganador: N√∫mero ${winnerNumber} (${rifa.winner.participant_name})
                        </p>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="navigateTo('perfil')">
                            ‚Üê Volver a Mis Simulaciones
                        </button>
                        <button class="btn btn-primary" onclick="editRifa(${rifaId})" style="margin-left: 10px;">
                            ‚úèÔ∏è Editar
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px;" class="rifa-details-grid">
                        <div class="numbers-section">
                            <h3 style="margin-bottom: 15px;">üéØ N√∫meros de la Simulaci√≥n</h3>
                            <div class="numbers-grid">
                                ${numbersGridHtml}
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="color: #333; margin-bottom: 10px;">üìä Estad√≠sticas</h4>
                                <p style="margin: 5px 0;">‚Ä¢ N√∫meros ocupados: ${rifa.numbers_sold}/100</p>
                                <p style="margin: 5px 0;">‚Ä¢ Progreso: ${progressPercent}%</p>
                                <p style="margin: 5px 0;">‚Ä¢ C√≥digo de acceso: ${rifa.access_code || 'No disponible'}</p>
                            </div>
                        </div>
                        
                        <div class="cart-section">
                            <div class="cart-header">
                                <span class="cart-icon">üéØ</span>
                                <h3 class="cart-title">${isCompleted ? 'Resultado Final' : 'Informaci√≥n'}</h3>
                            </div>
                            
                            ${isCompleted ? `
                            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center; border: 2px solid #ffd700;">
                                <h4 style="color: #856404; margin: 0 0 10px 0; font-size: 1.1rem;">üèÜ ¬°GANADOR!</h4>
                                <div style="font-size: 2.5rem; font-weight: bold; color: #ffd700; margin: 10px 0;">${winnerNumber}</div>
                                <p style="color: #856404; margin: 0; font-weight: bold; font-size: 1.1rem;">${rifa.winner.participant_name}</p>
                            </div>` : ''}
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 10px;">üìù Descripci√≥n</h4>
                                <p style="color: #666; line-height: 1.5;">${rifa.description}</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 10px;">üìà Progreso</h4>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                </div>
                                <p class="progress-text">${rifa.numbers_sold}/100 n√∫meros</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #333; margin-bottom: 10px;">üîë C√≥digo de Acceso</h4>
                                <div class="access-code-display" style="display: flex; align-items: center; justify-content: space-between;">
                                    <span id="displayCode">${rifa.access_code || 'GENERANDO...'}</span>
                                    <button class="copy-code-btn" onclick="copyCode('${rifa.access_code}')" title="Copiar c√≥digo">
                                        üìã
                                    </button>
                                </div>
                                <p style="font-size: 0.8rem; color: #666; text-align: center;">Comparte este c√≥digo para que otros participen</p>
                            </div>
                            
                            ${!isCompleted ? `
                            <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="drawRifaWinner(${rifaId})">
                                üèÜ Realizar Sorteo
                            </button>` : `
                            <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px; margin-bottom: 10px;">
                                <p style="color: #2e7d32; font-weight: bold; margin: 0;">‚úì Sorteo Completado</p>
                            </div>`}
                            
                            <button class="btn btn-primary" style="width: 100%;" onclick="editRifa(${rifaId})">
                                ‚úèÔ∏è Editar Simulaci√≥n
                            </button>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ [DEBUG] Vista cargada exitosamente');
                
            } catch (error) {
                console.error('‚ùå [ERROR] Error en viewRifa:', error);
                
                // Mostrar error detallado
                document.getElementById('mainContainer').innerHTML = `
                    <div class="page-header">
                        <h1>‚ö†Ô∏è Error Cargando Simulaci√≥n</h1>
                        <p class="subtitle">No se pudo cargar la simulaci√≥n ID: ${rifaId}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="navigateTo('perfil')">
                            ‚Üê Volver a Mis Simulaciones
                        </button>
                    </div>
                    
                    <div style="background: white; border-radius: 15px; padding: 30px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">‚ùå</div>
                        <h3 style="color: #333; margin-bottom: 15px;">Error de Conexi√≥n</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            ${error.message}
                        </p>
                        
                        <div style="background: #ffebee; border: 1px solid #ffcdd2; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: left;">
                            <h4 style="color: #c62828; margin: 0 0 10px 0;">üîß Informaci√≥n de Debug:</h4>
                            <p style="color: #c62828; font-size: 0.9rem; margin: 0;">
                                ‚Ä¢ ID de simulaci√≥n: ${rifaId}<br>
                                ‚Ä¢ Token disponible: ${token ? 'S√≠' : 'No'}<br>
                                ‚Ä¢ API Base: ${API_BASE}<br>
                                ‚Ä¢ Error: ${error.message}
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="viewRifa(${rifaId})">
                                üîÑ Reintentar
                            </button>
                            <button class="btn btn-secondary" onclick="navigateTo('perfil')">
                                ‚Üê Volver
                            </button>
                        </div>
                    </div>
                `;
                
                // Tambi√©n mostrar notificaci√≥n
                showNotification(error.message, 'error');
            }
        }
        
        async function editRifa(rifaId) {
            try {
                // Cargar datos de la rifa
                const response = await fetch(`${API_BASE}/rifas/my/${rifaId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const rifa = data.rifa;
                    
                    // Cargar datos en el modal de edici√≥n
                    document.getElementById('editRifaTitle').value = rifa.title;
                    document.getElementById('editRifaDescription').value = rifa.description;
                    
                    // Mostrar modal
                    document.getElementById('editRifaModal').style.display = 'flex';
                    
                    // Guardar ID para el submit
                    document.getElementById('editRifaForm').dataset.rifaId = rifaId;
                } else {
                    showNotification('Error cargando datos de la simulaci√≥n', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        }

        async function viewRifa(rifaId) {
            document.getElementById('mainContainer').innerHTML = `
                <div class="loading">
                    <p>üîÑ Cargando detalles de la simulaci√≥n...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/rifas/my/${rifaId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const rifa = data.rifa;
                    
                    // Generar grid de n√∫meros
                    let numbersGridHtml = '';
                    for (let i = 0; i <= 99; i++) {
                        const isSelected = rifa.sold_numbers && rifa.sold_numbers.includes(i);
                        const cellClass = isSelected ? 'number-cell sold' : 'number-cell';
                        numbersGridHtml += `<div class="${cellClass}">${i.toString().padStart(2, '0')}</div>`;
                    }
                    
                    const progressPercent = Math.round((rifa.numbers_sold / 100) * 100);
                    
                    document.getElementById('mainContainer').innerHTML = `
                        <div class="page-header">
                            <h1>üéØ ${rifa.title}</h1>
                            <p class="subtitle">${rifa.description}</p>
                            ${isCompleted ? `<p style="background: #4caf50; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px;">
                                üèÜ ¬°SIMULACI√ìN COMPLETADA! Ganador: N√∫mero ${winnerNumber} (${rifa.winner.participant_name})
                            </p>` : ''}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-secondary" onclick="navigateTo('perfil')">
                                ‚Üê Volver a Mis Simulaciones
                            </button>
                            <button class="btn btn-primary" onclick="editRifa(${rifaId})" style="margin-left: 10px;">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px;" class="rifa-details-grid">
                            <div class="numbers-section">
                                <h3 style="margin-bottom: 15px;">üéØ N√∫meros de la Simulaci√≥n</h3>
                                <div class="numbers-grid">
                                    ${numbersGridHtml}
                                </div>
                                
                                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">üìä Estad√≠sticas</h4>
                                    <p style="margin: 5px 0;">‚Ä¢ N√∫meros ocupados: ${rifa.numbers_sold}/100</p>
                                    <p style="margin: 5px 0;">‚Ä¢ Progreso: ${progressPercent}%</p>
                                    <p style="margin: 5px 0;">‚Ä¢ C√≥digo de acceso: ${rifa.access_code || 'No disponible'}</p>
                                </div>
                            </div>
                            
                            <div class="cart-section">
                                <div class="cart-header">
                                    <span class="cart-icon">üéØ</span>
                                    <h3 class="cart-title">${isCompleted ? 'Resultado Final' : 'Informaci√≥n'}</h3>
                                </div>
                                
                                ${isCompleted ? `
                                <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center; border: 2px solid #ffd700;">
                                    <h4 style="color: #856404; margin: 0 0 10px 0; font-size: 1.1rem;">üèÜ ¬°GANADOR!</h4>
                                    <div style="font-size: 2.5rem; font-weight: bold; color: #ffd700; margin: 10px 0;">${winnerNumber}</div>
                                    <p style="color: #856404; margin: 0; font-weight: bold; font-size: 1.1rem;">${rifa.winner.participant_name}</p>
                                </div>` : ''}
                                
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">üìù Descripci√≥n</h4>
                                    <p style="color: #666; line-height: 1.5;">${rifa.description}</p>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">üìà Progreso</h4>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <p class="progress-text">${rifa.numbers_sold}/100 n√∫meros</p>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #333; margin-bottom: 10px;">üîë C√≥digo de Acceso</h4>
                                    <div class="access-code-display" style="display: flex; align-items: center; justify-content: space-between;">
                                        <span id="displayCode">${rifa.access_code || 'GENERANDO...'}</span>
                                        <button class="copy-code-btn" onclick="copyCode('${rifa.access_code}')" title="Copiar c√≥digo">
                                            üìã
                                        </button>
                                    </div>
                                    <p style="font-size: 0.8rem; color: #666; text-align: center;">Comparte este c√≥digo para que otros participen</p>
                                </div>
                                
                                ${!isCompleted ? `
                                <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="drawRifaWinner(${rifaId})">
                                    üèÜ Realizar Sorteo
                                </button>` : `
                                <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="color: #2e7d32; font-weight: bold; margin: 0;">‚úì Sorteo Completado</p>
                                </div>`}
                                
                                <button class="btn btn-primary" style="width: 100%;" onclick="editRifa(${rifaId})">
                                    ‚úèÔ∏è Editar Simulaci√≥n
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    showNotification('Simulaci√≥n no encontrada', 'error');
                    navigateTo('perfil');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
                navigateTo('perfil');
            }
        }

        async function deleteRifa(rifaId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta simulaci√≥n? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/rifas/${rifaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Simulaci√≥n eliminada exitosamente');
                    showPerfilPage(); // Recargar la p√°gina de perfil
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Error eliminando simulaci√≥n', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        }
        
        async function drawRifaWinner(rifaId) {
            try {
                const response = await fetch(`${API_BASE}/rifas/${rifaId}/draw`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showNotification(`¬°Ganador: N√∫mero ${data.winner.number}! Participante: ${data.winner.participant_name}`);
                    // Recargar vista para mostrar el ganador
                    viewRifa(rifaId);
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Error realizando sorteo', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        }

        function showCreateRifaModal() {
            document.getElementById('createRifaModal').style.display = 'flex';
        }

        function closeCreateRifaModal() {
            document.getElementById('createRifaModal').style.display = 'none';
        }

        function closeEditRifaModal() {
            document.getElementById('editRifaModal').style.display = 'none';
        }

        // Event listener para crear simulaci√≥n
        document.getElementById('createRifaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('rifaTitle').value;
            const description = document.getElementById('rifaDescription').value;
            
            if (!title.trim()) {
                showNotification('El t√≠tulo es requerido', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/rifas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ title, description })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showNotification('Simulaci√≥n creada exitosamente');
                    closeCreateRifaModal();
                    document.getElementById('createRifaForm').reset();
                    // Recargar la p√°gina de perfil para mostrar la nueva simulaci√≥n
                    showPerfilPage();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Error creando simulaci√≥n', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        });

        document.getElementById('editRifaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rifaId = this.dataset.rifaId;
            const title = document.getElementById('editRifaTitle').value;
            const description = document.getElementById('editRifaDescription').value;
            
            if (!rifaId) {
                showNotification('Error: ID de simulaci√≥n no v√°lido', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/rifas/${rifaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ title, description })
                });
                
                if (response.ok) {
                    showNotification('Simulaci√≥n actualizada exitosamente');
                    closeEditRifaModal();
                    // Recargar la vista actual
                    viewRifa(rifaId);
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Error actualizando simulaci√≥n', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            }
        });

        // NUEVA FUNCI√ìN: Copiar c√≥digo al portapapeles
        async function copyCode(code) {
            if (!code || code === 'GENERANDO...') {
                showNotification('No hay c√≥digo disponible para copiar', 'error');
                return;
            }
            
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    // Usar Clipboard API (moderno)
                    await navigator.clipboard.writeText(code);
                    showNotification(`C√≥digo ${code} copiado al portapapeles`);
                } else {
                    // Fallback para navegadores m√°s antiguos
                    const textArea = document.createElement('textarea');
                    textArea.value = code;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        showNotification(`C√≥digo ${code} copiado al portapapeles`);
                    } catch (err) {
                        showNotification('Error al copiar c√≥digo', 'error');
                    }
                    
                    document.body.removeChild(textArea);
                }
            } catch (err) {
                console.error('Error copiando c√≥digo:', err);
                showNotification('Error al copiar c√≥digo', 'error');
            }
        }
        async function handleAccessCodeSubmit(e) {
            e.preventDefault();
            
            const code = document.getElementById('accessCodePageInput').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                showNotification('Por favor ingresa un c√≥digo v√°lido de 6 caracteres', 'error');
                return;
            }
            
            // Mostrar loading
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'üîÑ Buscando...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/rifas/access/${code}`);
                const data = await response.json();
                
                if (response.ok && data.rifa) {
                    showNotification('‚úÖ ¬°Simulaci√≥n encontrada!');
                    // Mostrar simulaci√≥n encontrada
                    viewRifaByCode(data.rifa, code);
                } else {
                    showNotification(data.error || `C√≥digo "${code}" no encontrado`, 'error');
                    // Restaurar bot√≥n
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n con el servidor', 'error');
                // Restaurar bot√≥n
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ========== FUNCI√ìN ACCESO POR C√ìDIGO ==========
        
        async function viewRifaByCode(rifa, accessCode) {
            const isCompleted = rifa.status === 'completed';
            const winnerNumber = rifa.winner ? rifa.winner.number : null;
            
            document.getElementById('mainContainer').innerHTML = `
                <div class="page-header">
                    <h1>üéØ ${rifa.title}</h1>
                    <p class="subtitle">Simulaci√≥n privada - Acceso por c√≥digo: ${accessCode}</p>
                    ${isCompleted ? `<p style="background: #4caf50; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px;">
                        üèÜ ¬°SIMULACI√ìN COMPLETADA! Ganador: N√∫mero ${winnerNumber} (${rifa.winner.participant_name})
                    </p>` : ''}
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="navigateTo('codigo')">
                        ‚Üê Buscar Otro C√≥digo
                    </button>
                </div>
                
                <div class="legal-notice">
                    <strong>${isCompleted ? 'Simulaci√≥n Finalizada:' : 'Participaci√≥n An√≥nima:'}</strong> 
                    ${isCompleted ? 
                        'Esta simulaci√≥n ya fue sorteada. Los n√∫meros en rojo estaban ocupados y el n√∫mero dorado es el ganador.' : 
                        'Puedes participar sin registrarte. Los n√∫meros en rojo ya est√°n ocupados.'}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px;" class="rifa-details-grid">
                    <div class="numbers-section">
                        <h3 style="margin-bottom: 15px;">üéØ N√∫meros de la Simulaci√≥n</h3>
                        ${isCompleted ? 
                            '<p style="color: #666; margin-bottom: 20px;">Simulaci√≥n finalizada - Ver resultados</p>' :
                            '<p style="color: #666; margin-bottom: 20px;">Haz click en los n√∫meros disponibles para participar</p>'
                        }
                        
                        <div class="numbers-grid" id="numbersGridCode">
                            <!-- Los n√∫meros se generan con JavaScript -->
                        </div>
                        
                        ${!isCompleted ? `
                        <div style="margin-top: 20px;">
                            <button class="btn btn-participate" id="participateBtn" onclick="showParticipateModal('${accessCode}')" disabled>
                                üéâ Participar en Simulaci√≥n
                            </button>
                        </div>` : ''}
                    </div>
                    
                    <div class="cart-section">
                        <div class="cart-header">
                            <span class="cart-icon">üéØ</span>
                            <h3 class="cart-title">${isCompleted ? 'Resultado' : 'Mis N√∫meros'}</h3>
                            ${!isCompleted ? '<div class="cart-count" id="cartCountCode">0</div>' : ''}
                        </div>
                        
                        ${!isCompleted ? `
                        <div class="cart-items" id="cartItemsCode">
                            <div class="empty-cart">No has seleccionado n√∫meros a√∫n</div>
                        </div>
                        
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                            <h4 style="color: #333; margin: 0; font-size: 1rem;">üéØ ${rifa.title}</h4>
                        </div>` : `
                        <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; text-align: center; border: 2px solid #ffd700;">
                            <h4 style="color: #856404; margin: 0 0 10px 0; font-size: 1.1rem;">üèÜ ¬°GANADOR!</h4>
                            <div style="font-size: 2rem; font-weight: bold; color: #ffd700; margin: 10px 0;">${winnerNumber}</div>
                            <p style="color: #856404; margin: 0; font-weight: bold;">${rifa.winner.participant_name}</p>
                        </div>
                        
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                            <h4 style="color: #333; margin: 0; font-size: 1rem;">üéØ ${rifa.title}</h4>
                        </div>`}
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">üìù Descripci√≥n</h4>
                            <p style="color: #666; line-height: 1.5; font-size: 0.9rem;">${rifa.description}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">üìà Progreso</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.round((rifa.numbers_sold / 100) * 100)}%"></div>
                            </div>
                            <p class="progress-text">${rifa.numbers_sold}/100 n√∫meros seleccionados</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">‚ÑπÔ∏è Detalles</h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">‚Ä¢ Creador: ${rifa.creator_username || 'Privado'}</p>
                            <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">‚Ä¢ Tipo: Simulaci√≥n privada</p>
                            <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">‚Ä¢ Estado: ${isCompleted ? 'Finalizada' : 'Activa'}</p>
                            ${isCompleted ? `<p style="color: #666; font-size: 0.9rem; margin: 5px 0;">‚Ä¢ Ganador: N√∫mero ${winnerNumber}</p>` : ''}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                                üí° ¬øTe gusta esta simulaci√≥n?
                            </p>
                            ${!isCompleted ? `
                            <button class="btn btn-participate" onclick="showParticipateModal('${accessCode}')" id="participateBtnSide" disabled style="width: 100%; margin-bottom: 10px;">
                                üéâ PARTICIPAR
                            </button>` : ''}
                            <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="showAuthModal()">
                                üöÄ Crear Mi Propia Simulaci√≥n
                            </button>
                            <button class="btn btn-secondary" style="width: 100%;" onclick="navigateTo('demo')">
                                üéÆ Probar Simulador
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Configurar variables globales para esta simulaci√≥n
            currentRifa = rifa;
            selectedNumbers = [];
            accessedByCode = true;
            
            // Generar grid de n√∫meros
            generateNumbersGridForCode(rifa.sold_numbers || [], winnerNumber, isCompleted);
            if (!isCompleted) {
                updateCartForCode();
            }
        }
        
        function generateNumbersGridForCode(soldNumbers, winnerNumber = null, isCompleted = false) {
            const grid = document.getElementById('numbersGridCode');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            for (let i = 0; i <= 99; i++) {
                const cell = document.createElement('div');
                const isSold = soldNumbers.includes(i);
                const isWinner = winnerNumber === i;
                
                if (isWinner) {
                    cell.className = 'number-cell winner';
                } else if (isSold) {
                    cell.className = 'number-cell sold';
                } else {
                    cell.className = 'number-cell';
                }
                
                cell.textContent = i.toString().padStart(2, '0');
                
                // Solo permitir clicks si no est√° completada y no est√° vendido
                if (!isCompleted && !isSold && !isWinner) {
                    cell.onclick = () => toggleNumberForCode(i);
                }
                
                cell.id = `number-code-${i}`;
                grid.appendChild(cell);
            }
        }
        
        function toggleNumberForCode(number) {
            const cell = document.getElementById(`number-code-${number}`);
            if (!cell || cell.classList.contains('sold')) return;
            
            const index = selectedNumbers.indexOf(number);
            
            if (index > -1) {
                selectedNumbers.splice(index, 1);
                cell.classList.remove('selected');
                const deleteBtn = cell.querySelector('.delete-number');
                if (deleteBtn) {
                    deleteBtn.remove();
                }
            } else {
                selectedNumbers.push(number);
                cell.classList.add('selected');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-number';
                deleteBtn.innerHTML = '‚úï';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    toggleNumberForCode(number);
                };
                cell.appendChild(deleteBtn);
            }
            
            updateCartForCode();
        }
        
        function updateCartForCode() {
            const cartItems = document.getElementById('cartItemsCode');
            const cartCount = document.getElementById('cartCountCode');
            const participateBtn = document.getElementById('participateBtn');
            const participateBtnSide = document.getElementById('participateBtnSide'); // NUEVO: Bot√≥n lateral
            
            if (!cartItems || !cartCount || !participateBtn) return;
            
            cartCount.textContent = selectedNumbers.length;
            
            if (selectedNumbers.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart">No has seleccionado n√∫meros a√∫n</div>';
                participateBtn.disabled = true;
                if (participateBtnSide) participateBtnSide.disabled = true; // NUEVO: Deshabilitar bot√≥n lateral
                return;
            }
            
            participateBtn.disabled = false;
            if (participateBtnSide) participateBtnSide.disabled = false; // NUEVO: Habilitar bot√≥n lateral
            
            const sortedNumbers = [...selectedNumbers].sort((a, b) => a - b);
            cartItems.innerHTML = sortedNumbers.map(number => `
                <div class="cart-item">
                    <span class="cart-item-number">${number.toString().padStart(2, '0')}</span>
                    <button class="remove-btn" onclick="toggleNumberForCode(${number})">‚úï</button>
                </div>
            `).join('');
        }
        
        function showParticipateModal(accessCode) {
            if (selectedNumbers.length === 0) {
                showNotification('Primero selecciona al menos un n√∫mero', 'error');
                return;
            }
            
            const modalHtml = `
                <div class="modal" id="participateModal" style="display: flex;">
                    <div class="modal-content">
                        <h2>üéâ Participar en Simulaci√≥n</h2>
                        <p style="margin-bottom: 20px; color: #666; text-align: center;">
                            Vas a participar con ${selectedNumbers.length} n√∫mero${selectedNumbers.length > 1 ? 's' : ''}
                        </p>
                        <form id="participateForm">
                            <input type="text" id="participantName" placeholder="Tu nombre" class="form-input" required>
                            <div class="modal-buttons">
                                <button type="button" class="btn btn-secondary" onclick="closeParticipateModal()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Confirmar Participaci√≥n</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            document.getElementById('participateForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const participantName = document.getElementById('participantName').value.trim();
                
                if (!participantName) {
                    showNotification('Por favor ingresa tu nombre', 'error');
                    return;
                }
                
                // Mostrar loading en bot√≥n
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = 'üîÑ Confirmando...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch(`${API_BASE}/rifas/access/${accessCode}/numbers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            numbers: selectedNumbers,
                            participant_name: participantName
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showNotification(`¬°Participaci√≥n confirmada! N√∫meros: ${selectedNumbers.join(', ')}`);
                        closeParticipateModal();
                        
                        // Recargar la simulaci√≥n para mostrar los n√∫meros ocupados
                        const refreshResponse = await fetch(`${API_BASE}/rifas/access/${accessCode}`);
                        if (refreshResponse.ok) {
                            const refreshData = await refreshResponse.json();
                            viewRifaByCode(refreshData.rifa, accessCode);
                        }
                    } else {
                        showNotification(data.error || 'Error en participaci√≥n', 'error');
                        // Restaurar bot√≥n
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Error de conexi√≥n', 'error');
                    // Restaurar bot√≥n
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        }
        
        function closeParticipateModal() {
            const modal = document.getElementById('participateModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ========== CERRAR MODALES AL HACER CLICK FUERA ==========
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>